name: ğŸŒ Full CI/CD â€” Terraform + Docker + AWS

on:
  push:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "**/*.tf"
      - "**/*.yml"
      - "**/*.py"
      - "**/*.js"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: eu-north-1
      IMAGE_TAG: latest
      ECR_REPO_NAME: my-simple-app

    steps:
      # 1ï¸âƒ£ Checkout code
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configure AWS credentials
      - name: ğŸ”‘ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3ï¸âƒ£ Setup Terraform
      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      # 4ï¸âƒ£ Initialize Terraform
      - name: ğŸš€ Terraform Init
        run: terraform init

      # 5ï¸âƒ£ Apply Terraform (auto-approve)
      - name: ğŸ—ï¸ Terraform Apply
        id: apply
        run: terraform apply -auto-approve

      # 6ï¸âƒ£ Capture Terraform outputs safely (no debug noise)
      - name: ğŸ“¦ Get Terraform Outputs
        id: outputs
        run: |
          EC2_PUBLIC_IP=$(terraform output -raw ec2_public_ip)
          ECR_URI=$(terraform output -raw ecr_repository_uri)
          echo "EC2_PUBLIC_IP=$EC2_PUBLIC_IP" >> $GITHUB_ENV
          echo "ECR_URI=$ECR_URI" >> $GITHUB_ENV

      # 7ï¸âƒ£ Log in to Amazon ECR
      - name: ğŸ³ Login to Amazon ECR
        run: |
          echo "ğŸ” Logging into ECR: $ECR_URI"
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_URI

      # 8ï¸âƒ£ Build and Push Docker Image
      - name: ğŸ§± Build & Push Docker image
        run: |
          IMAGE_URI=${ECR_URI}:${IMAGE_TAG}
          echo "ğŸ—ï¸ Building image: $IMAGE_URI"
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      # 9ï¸âƒ£ Deploy the container on EC2 using SSH
      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_PUBLIC_IP }}
          username: ec2-user
          key: ${{ steps.apply.outputs.private_key_pem || secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "âœ… Connected to EC2"
            sudo yum install -y docker
            sudo systemctl start docker
            sudo docker ps -q --filter "name=my-simple-app" | xargs -r sudo docker stop
            sudo docker ps -aq --filter "name=my-simple-app" | xargs -r sudo docker rm
            sudo docker pull ${{ env.IMAGE_URI }}
            sudo docker run -d -p 8090:80 --name my-simple-app ${{ env.IMAGE_URI }}

      # ğŸ”Ÿ Print Live Web App URL
      - name: ğŸŒ Show Live Web URL
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸŒ Live Web App: http://${{ env.EC2_PUBLIC_IP }}:8090"
