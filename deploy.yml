---
- name: Deploy my-simple-app from AWS ECR
  hosts: web
  become: yes
  vars:
    ecr_region: eu-north-1
    ecr_repo: 456501836709.dkr.ecr.eu-north-1.amazonaws.com/my-simple-app
    container_name: my-simple-app
    container_port: 80

  tasks:
    - name: Install required packages
      ansible.builtin.yum:
        name:
          - yum-utils
          - device-mapper-persistent-data
          - lvm2
        state: present

    - name: Enable Docker repository
      ansible.builtin.command: amazon-linux-extras enable docker
      args:
        creates: /etc/yum.repos.d/docker.repo

    - name: Install Docker
      ansible.builtin.yum:
        name: docker
        state: present

    - name: Start Docker service
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Install Python Docker module
      ansible.builtin.pip:
        name: docker
        state: present

    - name: Login to AWS ECR
      ansible.builtin.shell: |
        aws ecr get-login-password --region {{ ecr_region }} | docker login --username AWS --password-stdin {{ ecr_repo }}
      environment:
        AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
        AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
        AWS_DEFAULT_REGION: "{{ ecr_region }}"

    - name: Pull my-simple-app image from ECR
      community.docker.docker_image:
        name: "{{ ecr_repo }}:latest"
        source: pull

    - name: Remove old container if exists
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: absent

    - name: Run my-simple-app container
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ ecr_repo }}:latest"
        state: started
        restart_policy: always
        published_ports:
          - "{{ container_port }}:80"
