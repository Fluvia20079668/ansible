---
- name: Deploy my-simple-app to EC2
  hosts: ec2
  become: yes
  vars:
    ecr_repo: "{{ ecr_repo }}"
    image_tag: "latest"
    commit_sha: "{{ commit_sha }}"
    container_name: "my-simple-app"
    exposed_port: 80
    container_port: 8090

  tasks:
    # 1️⃣ Ensure Docker is installed
    - name: Ensure Docker is installed
      ansible.builtin.yum:
        name: docker
        state: present

    # 2️⃣ Start Docker service
    - name: Start Docker service
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    # 3️⃣ Log in to Amazon ECR
    - name: Log in to ECR
      community.aws.ecr_login:
        region: eu-north-1

    # 4️⃣ Cleanup old container if exists
    - name: Cleanup old container if exists
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: absent
        force_kill: yes
        remove_volumes: yes

    # 5️⃣ Remove dangling Docker images
    - name: Remove dangling Docker images
      community.docker.docker_image:
        name: "<none>"
        state: absent
        prune: yes

    # 6️⃣ Pull Docker images (latest + commit SHA)
    - name: Pull Docker images
      community.docker.docker_image:
        name: "{{ ecr_repo }}"
        tag: "{{ item }}"
        source: pull
      loop:
        - "{{ image_tag }}"
        - "{{ commit_sha }}"

    # 7️⃣ Ensure container is running
    - name: Ensure container is running with latest image
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ ecr_repo }}:{{ image_tag }}"
        state: started
        restart_policy: always
        published_ports:
          - "{{ exposed_port }}:{{ container_port }}"
        pull: yes

    # 8️⃣ Get EC2 public IP
    - name: Get public IP of EC2 host
      ansible.builtin.shell: "curl -s http://169.254.169.254/latest/meta-data/public-ipv4"
      register: public_ip

    # 9️⃣ Display live URL
    - name: Show live URL
      ansible.builtin.debug:
        msg: "✅ Your app is live at: http://{{ public_ip.stdout }}/"
