name: ðŸš€ Terraform + Docker CI/CD

on:
  push:
    branches: [ "main" ]
    paths:
      - 'terraform/**'
      - 'Dockerfile'
      - '**/*.py'
      - '**/*.js'
      - '**/*.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: eu-north-1
      ECR_REPO_NAME: my-simple-app
      IMAGE_TAG: latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ› ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: â›ï¸ Terraform Init
        working-directory: terraform
        run: terraform init

      - name: ðŸŒ Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      - name: ðŸ“¡ Get Terraform outputs safely
        id: tf_outputs
        working-directory: terraform
        run: |
          # Extract clean outputs
          EC2_PUBLIC_IP=$(terraform output -raw ec2_public_ip 2>/dev/null || echo "")
          ECR_URI=$(terraform output -raw ecr_repository_uri 2>/dev/null || echo "")
          PRIVATE_KEY_PEM=$(terraform output -raw private_key_pem 2>/dev/null || echo "")

          # Validate required outputs
          if [ -z "$EC2_PUBLIC_IP" ] || [ -z "$ECR_URI" ]; then
            echo "âŒ Missing Terraform outputs. Check your Terraform definitions."
            terraform output
            exit 1
          fi

          echo "EC2_PUBLIC_IP=$EC2_PUBLIC_IP" >> $GITHUB_ENV
          echo "ECR_URI=$ECR_URI" >> $GITHUB_ENV

          # Save private key for SSH
          echo "$PRIVATE_KEY_PEM" > deploy_key.pem
          chmod 600 deploy_key.pem

      - name: ðŸ³ Docker Login to ECR
        run: |
          echo "Logging into ECR: $ECR_URI"
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_URI

      - name: ðŸ§± Build and Push Docker Image
        run: |
          IMAGE_URI=$ECR_URI:${{ env.IMAGE_TAG }}
          echo "Building and pushing $IMAGE_URI"
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      - name: ðŸš€ Deploy Docker on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i deploy_key.pem ec2-user@$EC2_PUBLIC_IP << EOF
            sudo yum install -y docker awscli
            sudo systemctl enable docker
            sudo systemctl start docker
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | sudo docker login --username AWS --password-stdin $ECR_URI
            sudo docker stop my-app || true
            sudo docker rm my-app || true
            sudo docker run -d -p 8090:8090 --name my-app --restart always $IMAGE_URI
          EOF

      - name: ðŸŒ App URL
        run: echo "âœ… Your app is live at: http://$EC2_PUBLIC_IP:8090"
